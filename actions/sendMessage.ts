"use server";

const mock = {
  status: "success",
  data: {
    status: "success",
    sql: "SELECT\n    StoreID,\n    Store_name,\n    Brand_name,\n    Market_name,\n    SUM(CASE WHEN Month = 1 THEN ROUND(CAST(REPLACE(Sales, ',', '') AS DOUBLE), 2) ELSE 0 END) AS January_Sales,\n    SUM(CASE WHEN Month = 2 THEN ROUND(CAST(REPLACE(Sales, ',', '') AS DOUBLE), 2) ELSE 0 END) AS February_Sales\nFROM data\nWHERE Brand_name = 'KFC' AND Market_name = 'UAE' AND Year = 2024\nGROUP BY 1, 2, 3, 4\nORDER BY 1, 3, 2;",
    table: {
      title: "2023-2024 Brand Sales Performance",
      subtitle: "Market-wise sales growth analysis across 67 brands.",
      data: {
        columns: [
          {
            key: "Market",
            label: "Market",
            dataType: "text",
            unit: "Text",
          },
          {
            key: "Brand",
            label: "Brand",
            dataType: "text",
            unit: "Text",
          },
          {
            key: "Sales_2023",
            label: "Sales 2023",
            dataType: "currency",
            unit: "$",
          },
          {
            key: "Sales_2024",
            label: "Sales 2024",
            dataType: "currency",
            unit: "$",
          },
          {
            key: "Growth_Percentage",
            label: "Growth Percentage",
            dataType: "percentage",
            unit: "%",
          },
        ],
        rows: [
          {
            Market: "Bahrain",
            Brand: "Hardees",
            Sales_2023: 10507846.78,
            Sales_2024: 8274085.0,
            Growth_Percentage: -21.26,
          },
          {
            Market: "Bahrain",
            Brand: "KFC",
            Sales_2023: 23673120.5,
            Sales_2024: 19399986.99,
            Growth_Percentage: -18.05,
          },
          {
            Market: "Bahrain",
            Brand: "Krispy Kreme",
            Sales_2023: 2526625.37,
            Sales_2024: 1906487.93,
            Growth_Percentage: -24.54,
          },
          {
            Market: "Bahrain",
            Brand: "PIZZA HUT",
            Sales_2023: 10526489.97,
            Sales_2024: 7651482.0,
            Growth_Percentage: -27.31,
          },
          {
            Market: "Bahrain",
            Brand: "TGI Fridays",
            Sales_2023: 2552934.66,
            Sales_2024: 2148386.85,
            Growth_Percentage: -15.85,
          },
          {
            Market: "Egypt",
            Brand: "Baskin Robbins",
            Sales_2023: 1243821.78,
            Sales_2024: 1360172.02,
            Growth_Percentage: 9.35,
          },
          {
            Market: "Egypt",
            Brand: "Chicken Tikka",
            Sales_2023: 9048203.2,
            Sales_2024: 10220682.17,
            Growth_Percentage: 12.96,
          },
          {
            Market: "Egypt",
            Brand: "Costa Coffee",
            Sales_2023: 15891114.99,
            Sales_2024: 17337035.44,
            Growth_Percentage: 9.1,
          },
          {
            Market: "Egypt",
            Brand: "Fish Market",
            Sales_2023: 2369880.57,
            Sales_2024: 2051039.6,
            Growth_Percentage: -13.45,
          },
          {
            Market: "Egypt",
            Brand: "Grand Cafe",
            Sales_2023: 932017.68,
            Sales_2024: 718041.72,
            Growth_Percentage: -22.96,
          },
          {
            Market: "Egypt",
            Brand: "Hardees",
            Sales_2023: 21597728.3,
            Sales_2024: 21112550.06,
            Growth_Percentage: -2.25,
          },
          {
            Market: "Egypt",
            Brand: "KFC",
            Sales_2023: 126020504.05,
            Sales_2024: 102767615.53,
            Growth_Percentage: -18.45,
          },
          {
            Market: "Egypt",
            Brand: "Krispy Kreme",
            Sales_2023: 11626545.46,
            Sales_2024: 11546981.37,
            Growth_Percentage: -0.68,
          },
          {
            Market: "Egypt",
            Brand: "PIZZA HUT",
            Sales_2023: 39779391.33,
            Sales_2024: 40314373.62,
            Growth_Percentage: 1.34,
          },
          {
            Market: "Egypt",
            Brand: "TGI Fridays",
            Sales_2023: 2213739.95,
            Sales_2024: 2060442.37,
            Growth_Percentage: -6.92,
          },
          {
            Market: "Egypt",
            Brand: "Wimpy",
            Sales_2023: 6290134.33,
            Sales_2024: 6311129.02,
            Growth_Percentage: 0.33,
          },
          {
            Market: "Iraq",
            Brand: "Hardees",
            Sales_2023: 10019503.09,
            Sales_2024: 11176331.43,
            Growth_Percentage: 11.55,
          },
          {
            Market: "Iraq",
            Brand: "KFC",
            Sales_2023: 20181294.57,
            Sales_2024: 20513328.14,
            Growth_Percentage: 1.65,
          },
          {
            Market: "Iraq",
            Brand: "PIZZA HUT",
            Sales_2023: 730993.98,
            Sales_2024: 1007572.21,
            Growth_Percentage: 37.84,
          },
          {
            Market: "Jordan",
            Brand: "Costa Coffee",
            Sales_2023: 2003340.67,
            Sales_2024: 1126382.98,
            Growth_Percentage: -43.77,
          },
          {
            Market: "Jordan",
            Brand: "Hardees",
            Sales_2023: 4438929.25,
            Sales_2024: 1385193.04,
            Growth_Percentage: -68.79,
          },
          {
            Market: "Jordan",
            Brand: "KFC",
            Sales_2023: 30077545.53,
            Sales_2024: 10711442.97,
            Growth_Percentage: -64.39,
          },
          {
            Market: "Jordan",
            Brand: "Krispy Kreme",
            Sales_2023: 2518544.66,
            Sales_2024: 913465.5,
            Growth_Percentage: -63.73,
          },
          {
            Market: "Jordan",
            Brand: "PIZZA HUT",
            Sales_2023: 13574497.34,
            Sales_2024: 4647405.04,
            Growth_Percentage: -65.76,
          },
          {
            Market: "KSA",
            Brand: "Chicken Tikka",
            Sales_2023: 204678.91,
            Sales_2024: 0.0,
            Growth_Percentage: -100.0,
          },
          {
            Market: "KSA",
            Brand: "Hardees",
            Sales_2023: 117427725.76,
            Sales_2024: 112079792.25,
            Growth_Percentage: -4.55,
          },
          {
            Market: "KSA",
            Brand: "KFC",
            Sales_2023: 386536040.95,
            Sales_2024: 368355360.83,
            Growth_Percentage: -4.7,
          },
          {
            Market: "KSA",
            Brand: "Krispy Kreme",
            Sales_2023: 42740268.41,
            Sales_2024: 36376430.07,
            Growth_Percentage: -14.89,
          },
          {
            Market: "KSA",
            Brand: "PIZZA HUT",
            Sales_2023: 30030973.26,
            Sales_2024: 48830920.41,
            Growth_Percentage: 62.6,
          },
          {
            Market: "KSA",
            Brand: "Peets Coffee",
            Sales_2023: 579632.07,
            Sales_2024: 2841730.55,
            Growth_Percentage: 390.26,
          },
          {
            Market: "KSA",
            Brand: "TGI Fridays",
            Sales_2023: 17384922.31,
            Sales_2024: 14140749.68,
            Growth_Percentage: -18.66,
          },
          {
            Market: "Kazak",
            Brand: "Costa Coffee",
            Sales_2023: 3330775.73,
            Sales_2024: 3248324.65,
            Growth_Percentage: -2.48,
          },
          {
            Market: "Kazak",
            Brand: "Hardees",
            Sales_2023: 13613599.43,
            Sales_2024: 14399725.07,
            Growth_Percentage: 5.77,
          },
          {
            Market: "Kazak",
            Brand: "KFC",
            Sales_2023: 109924228.46,
            Sales_2024: 112288030.58,
            Growth_Percentage: 2.15,
          },
          {
            Market: "Kazak",
            Brand: "Krispy Kreme",
            Sales_2023: 415357.31,
            Sales_2024: 962173.92,
            Growth_Percentage: 131.65,
          },
          {
            Market: "Kazak",
            Brand: "PIZZA HUT",
            Sales_2023: 1250670.9,
            Sales_2024: 458421.88,
            Growth_Percentage: -63.35,
          },
          {
            Market: "Kuwait",
            Brand: "Americana",
            Sales_2023: 15168.58,
            Sales_2024: 12719.36,
            Growth_Percentage: -16.15,
          },
          {
            Market: "Kuwait",
            Brand: "Baskin Robbins",
            Sales_2023: 18456996.48,
            Sales_2024: 15308750.39,
            Growth_Percentage: -17.06,
          },
          {
            Market: "Kuwait",
            Brand: "Chicken Tikka",
            Sales_2023: 6989568.47,
            Sales_2024: 6170331.89,
            Growth_Percentage: -11.72,
          },
          {
            Market: "Kuwait",
            Brand: "Fish Market",
            Sales_2023: 2305551.89,
            Sales_2024: 2384795.81,
            Growth_Percentage: 3.44,
          },
          {
            Market: "Kuwait",
            Brand: "Hardees",
            Sales_2023: 90999184.78,
            Sales_2024: 80470366.45,
            Growth_Percentage: -11.57,
          },
          {
            Market: "Kuwait",
            Brand: "KFC",
            Sales_2023: 176676822.2,
            Sales_2024: 164425459.36,
            Growth_Percentage: -6.93,
          },
          {
            Market: "Kuwait",
            Brand: "Krispy Kreme",
            Sales_2023: 8664204.76,
            Sales_2024: 7930126.28,
            Growth_Percentage: -8.47,
          },
          {
            Market: "Kuwait",
            Brand: "TGI Fridays",
            Sales_2023: 29464887.43,
            Sales_2024: 24055361.95,
            Growth_Percentage: -18.36,
          },
          {
            Market: "Kuwait",
            Brand: "Wimpy",
            Sales_2023: 5527867.97,
            Sales_2024: 5020702.29,
            Growth_Percentage: -9.17,
          },
          {
            Market: "Lebanon",
            Brand: "KFC",
            Sales_2023: 45616678.11,
            Sales_2024: 33632298.72,
            Growth_Percentage: -26.27,
          },
          {
            Market: "Morocco",
            Brand: "KFC",
            Sales_2023: 40403854.39,
            Sales_2024: 38468127.0,
            Growth_Percentage: -4.79,
          },
          {
            Market: "Morocco",
            Brand: "Krispy Kreme",
            Sales_2023: 0.0,
            Sales_2024: 285585.57,
            Growth_Percentage: null,
          },
          {
            Market: "Oman",
            Brand: "Hardees",
            Sales_2023: 7259762.51,
            Sales_2024: 3072476.9,
            Growth_Percentage: -57.68,
          },
          {
            Market: "Oman",
            Brand: "KFC",
            Sales_2023: 48954111.12,
            Sales_2024: 22532880.18,
            Growth_Percentage: -53.97,
          },
          {
            Market: "Oman",
            Brand: "PIZZA HUT",
            Sales_2023: 0.0,
            Sales_2024: 9986965.47,
            Growth_Percentage: null,
          },
          {
            Market: "Qatar",
            Brand: "Hardees",
            Sales_2023: 20284153.62,
            Sales_2024: 13968301.23,
            Growth_Percentage: -31.14,
          },
          {
            Market: "Qatar",
            Brand: "KFC",
            Sales_2023: 101623942.86,
            Sales_2024: 78861891.46,
            Growth_Percentage: -22.4,
          },
          {
            Market: "Qatar",
            Brand: "Krispy Kreme",
            Sales_2023: 6360507.53,
            Sales_2024: 5428028.02,
            Growth_Percentage: -14.66,
          },
          {
            Market: "Qatar",
            Brand: "TGI Fridays",
            Sales_2023: 5173052.71,
            Sales_2024: 5082905.64,
            Growth_Percentage: -1.74,
          },
          {
            Market: "UAE",
            Brand: "Carpo",
            Sales_2023: 0.0,
            Sales_2024: 0.0,
            Growth_Percentage: null,
          },
          {
            Market: "UAE",
            Brand: "Chicken Tikka",
            Sales_2023: 944313.39,
            Sales_2024: 804830.22,
            Growth_Percentage: -14.77,
          },
          {
            Market: "UAE",
            Brand: "Grand Cafe",
            Sales_2023: 81084.84,
            Sales_2024: 80053.52,
            Growth_Percentage: -1.27,
          },
          {
            Market: "UAE",
            Brand: "Hardees",
            Sales_2023: 101256287.54,
            Sales_2024: 106783749.46,
            Growth_Percentage: 5.46,
          },
          {
            Market: "UAE",
            Brand: "KFC",
            Sales_2023: 406226365.92,
            Sales_2024: 398935921.35,
            Growth_Percentage: -1.79,
          },
          {
            Market: "UAE",
            Brand: "Krispy Kreme",
            Sales_2023: 25087144.7,
            Sales_2024: 25554330.46,
            Growth_Percentage: 1.86,
          },
          {
            Market: "UAE",
            Brand: "PIZZA HUT",
            Sales_2023: 192615785.22,
            Sales_2024: 187527672.89,
            Growth_Percentage: -2.64,
          },
          {
            Market: "UAE",
            Brand: "Pavilion",
            Sales_2023: 9975.9,
            Sales_2024: 0.0,
            Growth_Percentage: -100.0,
          },
          {
            Market: "UAE",
            Brand: "Peets Coffee",
            Sales_2023: 2780696.8,
            Sales_2024: 7149195.6,
            Growth_Percentage: 157.1,
          },
          {
            Market: "UAE",
            Brand: "Red Lobster",
            Sales_2023: 0.0,
            Sales_2024: 0.0,
            Growth_Percentage: null,
          },
          {
            Market: "UAE",
            Brand: "TGI Fridays",
            Sales_2023: 18841161.35,
            Sales_2024: 17970065.05,
            Growth_Percentage: -4.62,
          },
          {
            Market: "UAE",
            Brand: "Wimpy",
            Sales_2023: 3340136.39,
            Sales_2024: 4643552.63,
            Growth_Percentage: 39.02,
          },
        ],
        SUM_TOTAL: {
          Sales_2023: 2459742888.97,
          Sales_2024: 2287190718.04,
        },
      },
    },
    json_file: "query_results.json",
    analysis_used: {
      entities: ["StoreID", "Store_name", "Brand_name", "Market_name"],
      metrics: ["Sales"],
      analysis_type: "pivot_comparison",
      is_pivot_required: true,
      comparison_years: [2024],
      time_dimension: "month",
      jinja_template:
        "SELECT\n    StoreID,\n    Store_name,\n    Brand_name,\n    Market_name,\n    SUM(CASE WHEN Month = 1 THEN ROUND(CAST(REPLACE(Sales, ',', '') AS DOUBLE), 2) ELSE 0 END) AS January_Sales,\n    SUM(CASE WHEN Month = 2 THEN ROUND(CAST(REPLACE(Sales, ',', '') AS DOUBLE), 2) ELSE 0 END) AS February_Sales\nFROM data\nWHERE Brand_name = 'KFC' AND Market_name = 'UAE' AND Year = {{ year }}\nGROUP BY 1, 2, 3, 4\nORDER BY 1, 3, 2;",
      template_variables: {
        year: 2024,
        year1: 2023,
        year2: 2024,
        metric: "Sales",
        entities: ["StoreID", "Store_name", "Brand_name", "Market_name"],
        metrics: ["Sales"],
        table_name: "data",
      },
      description:
        "This SQL query generates a pivot table showing January vs. February sales for KFC in UAE for the year 2024, broken down by store.",
    },
  },
  message: "Query executed successfully with analysis",
  sql: "SELECT\n    StoreID,\n    Store_name,\n    Brand_name,\n    Market_name,\n    SUM(CASE WHEN Month = 1 THEN ROUND(CAST(REPLACE(Sales, ',', '') AS DOUBLE), 2) ELSE 0 END) AS January_Sales,\n    SUM(CASE WHEN Month = 2 THEN ROUND(CAST(REPLACE(Sales, ',', '') AS DOUBLE), 2) ELSE 0 END) AS February_Sales\nFROM data\nWHERE Brand_name = 'KFC' AND Market_name = 'UAE' AND Year = 2024\nGROUP BY 1, 2, 3, 4\nORDER BY 1, 3, 2;",
  count: 208,
  graphs: [
    {
      type: "bar",
      data: {
        x: [
          "Americana",
          "Baskin Robbins",
          "Carpo",
          "Chicken Tikka",
          "Costa Coffee",
          "Fish Market",
          "Grand Cafe",
          "Hardees",
          "KFC",
          "Krispy Kreme",
          "PIZZA HUT",
          "Pavilion",
          "Peets Coffee",
          "Red Lobster",
          "TGI Fridays",
          "Wimpy",
        ],
        y: [
          15168.58, 19700818.26, 0.0, 17186763.97, 21225231.39, 4675432.46,
          1013102.52, 397404721.06000006, 1515914508.6599998, 99939198.2,
          288508802.0, 9975.9, 3360328.8699999996, 0.0, 75630698.41,
          15158138.69,
        ],
        name: "Sales (2023)",
      },
      meta: {
        title: "Compare Sales (2023) and Sales (2024) for each Brand.",
        x_label: "Brand",
        y_label: "Sales (2023)",
      },
    },
    {
      type: "line",
      data: {
        x: [
          "Bahrain",
          "Egypt",
          "Iraq",
          "Jordan",
          "KSA",
          "Kazak",
          "Kuwait",
          "Lebanon",
          "Morocco",
          "Oman",
          "Qatar",
          "UAE",
        ],
        y: [
          49787017.28, 237013081.64, 30931791.64, 52612857.45, 594904241.67,
          128534631.82999998, 339100252.56, 45616678.11, 40403854.39,
          56213873.629999995, 133441656.72, 751182952.05,
        ],
        name: "Sales (2023)",
      },
      meta: {
        title: "Show sales trend for each Market over time (2023-2024).",
        x_label: "Market",
        y_label: "Sales (2023)",
      },
    },
    {
      type: "bar",
      data: {
        x: [
          "Americana",
          "Baskin Robbins",
          "Carpo",
          "Chicken Tikka",
          "Costa Coffee",
          "Fish Market",
          "Grand Cafe",
          "Hardees",
          "KFC",
          "Krispy Kreme",
          "PIZZA HUT",
          "Pavilion",
          "Peets Coffee",
          "Red Lobster",
          "TGI Fridays",
          "Wimpy",
        ],
        y: [
          -16.15,
          -7.709999999999999,
          0.0,
          -113.52999999999999,
          -37.15,
          -10.01,
          -24.23,
          -174.46,
          -217.94,
          null,
          null,
          -100.0,
          547.36,
          0.0,
          -66.15,
          30.180000000000003,
        ],
        name: "Growth(%)",
      },
      meta: {
        title: "Rank Brands by Growth(%) in 2024.",
        x_label: "Brand",
        y_label: "Growth(%)",
      },
    },
  ],
  markdown: {
    title: "Analysis Report: 2023-2024 Brand Sales Performance",
    subtitle: "Market-wise sales growth analysis across 67 brands.",
    data: "# 2023-2024 Brand Sales Performance Report\n\n**Executive Summary:**\n\nThis report analyzes the sales performance of 67 brands across five key markets (Bahrain, Egypt, Iraq, Jordan, and KSA) from 2023 to 2024.  The analysis reveals a concerning overall decline in sales across the brands.  Key findings highlight significant variations in growth (or decline) between markets and individual brands, indicating a need for targeted strategies to address underperforming areas and brands.  Recommendations focus on deeper market-specific analysis, competitive benchmarking, and strategic marketing adjustments to reverse the negative sales trend.\n\n\n**1. Data Overview:**\n\nThe dataset comprises sales data for 67 brands across five markets (Bahrain, Egypt, Iraq, Jordan, and KSA) for the years 2023 and 2024.  The data includes sales figures for each brand in each market for both years, allowing for the calculation of year-over-year growth percentages.  The analysis focuses on identifying trends in sales growth and pinpointing areas requiring attention.  The data is summarized in the table below (partial view for brevity):\n\n| Market   | Brand          | Sales (2023)     | Sales (2024)     | Growth(%) |\n|----------|-----------------|-------------------|-------------------|-----------|\n| Bahrain  | Hardees         | 10507846.78      | 8274085.0        | -21.26     |\n| Egypt    | KFC             | 23673120.5       | 19399986.99      | -18.05     |\n| Iraq     | Krispy Kreme    | 2526625.37       | 1906487.93       | -24.54     |\n| Jordan   | PIZZA HUT       | 10526489.97      | 7651482.0        | -27.31     |\n| KSA      | TGI Fridays     | 2552934.66       | 2148386.85       | -15.85     |\n| ...      | ...             | ...               | ...               | ...       |\n\n\n**(Note:  The full dataset with 67 brands is available in the complete analysis.)**\n\n\n**2. Chart Analysis:**\n\n*(This section would include descriptions of three charts.  Since the charts are not provided, I will describe hypothetical charts that would be relevant to the data.)*\n\n* **Chart 1: Overall Market Growth:** A bar chart showing the average sales growth percentage for each market. This would highlight which markets experienced the most significant declines and which, if any, showed positive growth.  This chart would help identify markets requiring immediate attention.\n\n* **Chart 2: Top 10 Performing Brands:** A bar chart displaying the top 10 performing brands based on their sales growth percentage. This would identify successful brands and potentially reveal common factors contributing to their success.\n\n* **Chart 3: Brand Performance by Market:** A clustered bar chart comparing the sales of individual brands across different markets. This would reveal if certain brands are consistently underperforming across all markets or if their performance varies depending on the market.\n\n\n**3. Key Findings:**\n\n* **Overall Sales Decline:** The analysis reveals a general decline in sales across most brands from 2023 to 2024.\n* **Market Variation:**  The rate of sales decline varies significantly across different markets. Some markets show steeper declines than others, suggesting market-specific factors are at play.\n* **Brand-Specific Performance:**  Individual brand performance varies considerably, with some brands experiencing relatively smaller declines while others show substantial drops in sales.\n* **Need for Targeted Strategies:** The data strongly suggests the need for targeted interventions, tailored to specific markets and individual brands, to address the overall sales decline.\n\n\n**4. Recommendations:**\n\n* **Deep Dive Market Analysis:** Conduct a more in-depth analysis of each market, investigating factors such as economic conditions, competitive landscape, and consumer preferences to understand the reasons behind the varying sales performance.\n* **Competitive Benchmarking:**  Compare the performance of the brands against their key competitors in each market to identify areas for improvement and potential opportunities.\n* **Marketing Strategy Review:**  Review and adjust marketing strategies for underperforming brands and markets. This may involve changes to pricing, promotions, product offerings, or advertising campaigns.\n* **Operational Efficiency:** Investigate operational efficiencies within underperforming brands to identify cost-saving measures and improve profitability.\n* **Data-Driven Decision Making:**  Continue to monitor sales data closely and use data-driven insights to inform future business decisions.\n\n\nThis report provides a high-level overview of the sales performance.  A more detailed analysis, including the specific charts and a deeper dive into the individual market and brand performance, would provide more granular insights and more precise recommendations.",
  },
};

export async function sendMessageAction(data: string) {
  try {
    console.debug("from server", data);
    // const body = JSON.stringify({ query: data });
    // const res = await fetch("http://localhost:8000/query", {
    //   method: "POST",
    //   headers: {
    //     Accept: "application/json",
    //     "Content-Type": "application/json",
    //   },
    //   body,
    // });
    // const t = await res.json();
    // console.log(t);
    // return t;
    return mock;
  } catch (err) {
    console.error(err);
    return { error: "Internal Error" };
  }
}
